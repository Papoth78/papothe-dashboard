<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pilotage PapothÃ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; color:#333; }
    header { background:#6b1d1d; color:#fff; padding:1rem; text-align:center; }
    nav { background:#eee; display:flex; justify-content:center; gap:1rem; padding:0.5rem; }
    nav a { text-decoration:none; color:#333; font-weight:bold; }
    section { padding:1rem; }
    table { border-collapse: collapse; width:100%; margin-top:1rem; }
    th,td { border:1px solid #ddd; padding:8px; }
    th { background:#f4f4f4; }
    canvas { max-width:100%; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“Š Cockpit PapothÃ© 2025</h1>
  </header>
  <nav>
    <a href="#" onclick="showTab('dashboard')">Tableau de bord</a>
    <a href="#" onclick="showTab('ventes')">Ventes</a>
    <a href="#" onclick="showTab('produits')">Produits</a>
    <a href="#" onclick="showTab('factures')">Factures</a>
    <a href="#" onclick="showTab('banque')">Banque</a>
  </nav>

  <section id="dashboard">
    <h2>RÃ©sumÃ©</h2>
    <div id="kpi"></div>
    <canvas id="caChart"></canvas>
  </section>

  <section id="ventes" style="display:none;">
    <h2>Journal des ventes</h2>
    <table id="salesTable"></table>
  </section>

  <section id="produits" style="display:none;">
    <h2>Produits</h2>
    <table id="productsTable"></table>
  </section>

  <section id="factures" style="display:none;">
    <h2>Factures</h2>
    <table id="invoicesTable"></table>
  </section>

  <section id="banque" style="display:none;">
    <h2>Banque</h2>
    <table id="bankTable"></table>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // ---- CONFIG SUPABASE ----
  const SUPABASE_URL  = "https://hddozxsqysxdrqgqitny.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkZG96eHNxeXN4ZHJxZ3FpdG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzOTI0NDYsImV4cCI6MjA3MTk2ODQ0Nn0.ztFE5xIdsRppB7hWU1fnXdtaMomm5ny9DXxNVIq7mPU";

  async function sp(path, params="") {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/${path}${params}`, {
      headers: {
        apikey: SUPABASE_ANON,
        Authorization: `Bearer ${SUPABASE_ANON}`
      }
    });
    return r.json();
  }

  let DATA = { daily:[], products:[], journal:[], invoices:[], bankTx:[] };

  async function loadFromSupabase(){
    // Ventes
    const sales = await sp("sales","?select=date,customer_ref,amount_ttc,amount_ht,tva_amount,tva_rate,source,channel_id,product_id,qty");
    DATA.journal = sales;
    // Produits
    const prods = await sp("products","?select=name,price_ttc,cost_ht,tva_rate");
    DATA.products = prods;
    // Factures
    const invs = await sp("invoices","?select=supplier,invoice_number,date,total_ht,total_tva,total_ttc");
    DATA.invoices = invs;
    // Banque
    const bank = await sp("bank_tx","?select=date,description,amount,account");
    DATA.bankTx = bank;

    renderAll();
  }

  function renderAll(){
    renderKPIs();
    renderSales();
    renderProducts();
    renderInvoices();
    renderBank();
    renderCAChart();
  }

  function renderKPIs(){
    let totalCA = DATA.journal.reduce((a,b)=>a+Number(b.amount_ttc||0),0);
    document.getElementById("kpi").innerHTML = `<b>CA TTC :</b> ${totalCA.toFixed(2)} â‚¬`;
  }

  function renderSales(){
    let html = "<tr><th>Date</th><th>Client</th><th>TTC</th><th>HT</th><th>TVA</th></tr>";
    DATA.journal.forEach(s=>{
      html += `<tr><td>${s.date}</td><td>${s.customer_ref||""}</td><td>${s.amount_ttc}</td><td>${s.amount_ht}</td><td>${s.tva_amount}</td></tr>`;
    });
    document.getElementById("salesTable").innerHTML = html;
  }

  function renderProducts(){
    let html = "<tr><th>Produit</th><th>Prix TTC</th><th>CoÃ»t HT</th><th>TVA</th></tr>";
    DATA.products.forEach(p=>{
      html += `<tr><td>${p.name}</td><td>${p.price_ttc}</td><td>${p.cost_ht}</td><td>${p.tva_rate}</td></tr>`;
    });
    document.getElementById("productsTable").innerHTML = html;
  }

  function renderInvoices(){
    let html = "<tr><th>Fournisseur</th><th>NÂ°</th><th>Date</th><th>HT</th><th>TVA</th><th>TTC</th></tr>";
    DATA.invoices.forEach(f=>{
      html += `<tr><td>${f.supplier}</td><td>${f.invoice_number}</td><td>${f.date}</td><td>${f.total_ht}</td><td>${f.total_tva}</td><td>${f.total_ttc}</td></tr>`;
    });
    document.getElementById("invoicesTable").innerHTML = html;
  }

  function renderBank(){
    let html = "<tr><th>Date</th><th>Description</th><th>Montant</th><th>Compte</th></tr>";
    DATA.bankTx.forEach(b=>{
      html += `<tr><td>${b.date}</td><td>${b.description}</td><td>${b.amount}</td><td>${b.account}</td></tr>`;
    });
    document.getElementById("bankTable").innerHTML = html;
  }

  function renderCAChart(){
    const ctx = document.getElementById('caChart').getContext('2d');
    const byDate = {};
    DATA.journal.forEach(s=>{
      if(!byDate[s.date]) byDate[s.date]=0;
      byDate[s.date]+= Number(s.amount_ttc||0);
    });
    const labels = Object.keys(byDate).sort();
    const data = labels.map(l=>byDate[l]);
    new Chart(ctx,{ type:'line',
      data:{ labels, datasets:[{label:"CA quotidien", data, borderColor:"#6b1d1d"}] }
    });
  }

  function showTab(id){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
  }

  loadFromSupabase();
  </script>
</body>
</html>
