<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Papothé — Cockpit ventes & compta</title>
<link rel="icon" href="data:,">
<style>
:root{
  --bg:#faf7f4; --card:#ffffff; --ink:#0f2747; --muted:#6b778a;
  --brand:#d06a4e; --accent:#11335b; --success:#0f8a5f; --danger:#c13515;
  --shadow:0 6px 18px rgba(15,39,71,.08); --radius:14px;
}
*{box-sizing:border-box} html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
body{background:var(--bg);color:var(--ink)}
/* ======= TOP NAVBAR ======= */
.topbar{
  position:sticky; top:0; z-index:50;
  background:linear-gradient(180deg,#fff,#f6f2ec);
  border-bottom:1px solid #eee; box-shadow:var(--shadow);
}
.topbar-inner{max-width:1200px;margin:auto;display:flex;align-items:center;gap:16px;padding:10px 16px;flex-wrap:wrap}
.brand{font-weight:800;font-size:20px;color:var(--accent);white-space:nowrap}
.nav{display:flex;gap:6px;flex-wrap:wrap}
.nav-btn{border:0;background:transparent;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--ink)}
.nav-btn:hover{background:#f1ece7}
.nav-btn.active{background:var(--accent);color:#fff}
.period{margin-left:auto;display:flex;gap:8px;align-items:center;background:#fff;border-radius:10px;padding:6px 8px}
.period select,.period input,.period button{border:1px solid #e5e5e5;border-radius:8px;padding:8px 10px}
.period button{background:var(--brand);color:#fff;border:0;cursor:pointer}
.period button:hover{filter:brightness(.95)}
/* ======= LAYOUT ======= */
.container{max-width:1200px;margin:22px auto;padding:0 16px}
.page{display:none}
.page.visible{display:block}
h1{margin:8px 0 16px}
.kpis{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:14px;margin-bottom:16px}
.kpi{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
.kpi strong{font-size:22px}.kpi.success strong{color:var(--success)}.kpi.danger strong{color:var(--danger)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:var(--shadow)}
.card h3{margin:0 0 10px}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
.table thead th{color:var(--muted);font-weight:600}
.badge{padding:4px 8px;border-radius:999px;font-size:12px}.badge.success{background:#e7f6ef;color:#0f8a5f}.badge.warn{background:#fff6e0;color:#9c6a05}
.cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form label{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.form input{padding:10px;border:1px solid #e4e4e4;border-radius:8px}
button.btn{border:0;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
button.btn:hover{filter:brightness(.95)}
.score{margin-top:10px;padding:10px;background:#f5faf7;border:1px solid #d3efe3;border-radius:8px;color:var(--success);font-weight:700}
.legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;font-size:13px}
.legend .item{display:flex;align-items:center;gap:6px;background:#fafafa;border:1px solid #eee;border-radius:999px;padding:4px 8px}
.legend .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
/* Responsive */
@media (max-width:1100px){
  .kpis{grid-template-columns:1fr 1fr}
  .grid-2{grid-template-columns:1fr}
  .period{margin-left:0}
}
@media (max-width:640px){
  .nav{width:100%}
  .period{width:100%;flex-wrap:wrap}
  .kpis{grid-template-columns:1fr}
}
canvas.responsive{width:100%;height:auto;display:block}
</style>
</head>
<body>

<!-- ======= TOP NAV ======= -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">Papothé</div>
    <div class="nav">
      <button class="nav-btn active" data-target="dashboard">Tableau de bord</button>
      <button class="nav-btn" data-target="sales">Ventes</button>
      <button class="nav-btn" data-target="products">Produits</button>
      <button class="nav-btn" data-target="invoices">Factures</button>
      <button class="nav-btn" data-target="projects">Projets</button>
      <button class="nav-btn" data-target="benchmark">Benchmark</button>
      <button class="nav-btn" data-target="exports">Exports</button>
    </div>
    <div class="period">
      <label for="quickRange">Période</label>
      <select id="quickRange">
        <option value="last7">7 derniers jours</option>
        <option value="mtd">Mois en cours</option>
        <option value="qtd">Trimestre en cours</option>
        <option value="ytd" selected>Année en cours</option>
        <option value="all">Tout</option>
        <option value="custom">Personnalisé</option>
      </select>
      <input type="date" id="from"><span>→</span><input type="date" id="to">
      <button id="applyRange">Appliquer</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- DASHBOARD -->
  <section id="dashboard" class="page visible">
    <h1>Tableau de bord</h1>
    <div class="kpis">
      <div class="kpi"><div>CA TTC</div><strong id="kpi-cattt">—</strong></div>
      <div class="kpi"><div>CA HT</div><strong id="kpi-caht">—</strong></div>
      <div class="kpi"><div>Marge brute</div><strong id="kpi-marge">—</strong></div>
      <div class="kpi"><div>TVA collectée</div><strong id="kpi-tva">—</strong></div>
      <div class="kpi" id="kpi-result-box"><div>Résultat net</div><strong id="kpi-result">—</strong></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <h3>CA quotidien (réel)</h3>
        <canvas id="dashLine" class="responsive"></canvas>
      </div>
      <div class="card">
        <h3>Projection de trésorerie (simple)</h3>
        <canvas id="dashProj" class="responsive"></canvas>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <h3>Dépenses par type</h3>
        <canvas id="dashPie" class="responsive"></canvas>
        <div id="legend-expenses" class="legend"></div>
      </div>
      <div class="card">
        <h3>Répartition du CA par canal</h3>
        <canvas id="dashBar" class="responsive"></canvas>
        <div id="legend-channels" class="legend"></div>
      </div>
    </div>
  </section>

  <!-- SALES -->
  <section id="sales" class="page">
    <h1>Ventes</h1>
    <div class="kpis">
      <div class="kpi"><div>CA TTC</div><strong id="sales-cattt">—</strong></div>
      <div class="kpi"><div>Commandes</div><strong id="sales-orders">—</strong></div>
      <div class="kpi"><div>Panier moyen</div><strong id="sales-aov">—</strong></div>
      <div class="kpi"><div>Taux de réachat (simulé)</div><strong id="sales-repeat">—</strong></div>
    </div>
    <div class="grid-2">
      <div class="card"><h3>Ventes quotidiennes</h3><canvas id="salesLine" class="responsive"></canvas></div>
      <div class="card"><h3>CA par mois</h3><canvas id="salesBar" class="responsive"></canvas></div>
    </div>
    <div class="card">
      <h3>Journal des ventes (échantillon)</h3>
      <table id="salesTable" class="table"></table>
      <button id="exportCsv" class="btn">⬇️ Exporter CSV (journal)</button>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section id="products" class="page">
    <h1>Produits</h1>
    <div class="kpis">
      <div class="kpi"><div>Ventes totales</div><strong id="prod-qty">—</strong></div>
      <div class="kpi"><div>CA produits</div><strong id="prod-ca">—</strong></div>
      <div class="kpi"><div>Marge totale</div><strong id="prod-margin">—</strong></div>
      <div class="kpi"><div>Rentabilité moyenne</div><strong id="prod-roi">—</strong></div>
    </div>
    <div class="grid-2">
      <div class="card">
        <h3>Détails par produit</h3>
        <table id="prodTable" class="table"></table>
      </div>
      <div class="card">
        <h3>Classements</h3>
        <div class="cols">
          <div><h4>Top ventes</h4><ol id="topList"></ol></div>
          <div><h4>Flop produits</h4><ol id="flopList"></ol></div>
        </div>
      </div>
    </div>
    <div class="grid-2">
      <div class="card"><h3>CA par produit</h3><canvas id="prodBar" class="responsive"></canvas></div>
      <div class="card"><h3>Marge (%) par produit</h3><canvas id="prodBar2" class="responsive"></canvas></div>
    </div>
  </section>

  <!-- INVOICES -->
  <section id="invoices" class="page">
    <h1>Factures</h1>
    <div class="card">
      <p>Charge ici tes factures PDF/Excel pour extraction (démo UI) :</p>
      <input type="file" multiple/>
    </div>
    <div class="card">
      <h3>Exemples de factures</h3>
      <table class="table">
        <thead><tr><th>Date</th><th>Fournisseur</th><th>Montant HT</th><th>TVA</th><th>Catégorie</th><th>Statut</th></tr></thead>
        <tbody>
          <tr><td>2025-02-05</td><td>Thé Délices</td><td>1 250,00 €</td><td>5,5%</td><td>Stock</td><td><span class="badge success">Payée</span></td></tr>
          <tr><td>2025-01-28</td><td>Imprint Vert</td><td>340,50 €</td><td>20%</td><td>Packaging</td><td><span class="badge warn">En attente</span></td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- PROJECTS -->
  <section id="projects" class="page">
    <h1>Projets & Scénarios</h1>
    <div class="grid-2">
      <div class="card">
        <h3>Simulation</h3>
        <div class="form">
          <label>Nom du projet<input id="pName" placeholder="Ex. Salon Papothé & Co"/></label>
          <label>Investissement initial (€)<input type="number" id="pInvest" value="8000"/></label>
          <label>Trafic attendu<input type="number" id="pTraffic" value="1000"/></label>
          <label>Taux de conversion (%)<input type="number" id="pConv" value="7"/></label>
          <label>Panier moyen (€)<input type="number" id="pAOV" value="21"/></label>
          <label>Frais variables (%)<input type="number" id="pVar" value="18"/></label>
          <button id="pRun" class="btn">Calculer</button>
        </div>
      </div>
      <div class="card">
        <h3>Résultats</h3>
        <ul id="pResults"></ul>
        <div id="pScore" class="score">Score d'opportunité: —</div>
        <canvas id="projChart" class="responsive"></canvas>
      </div>
    </div>
  </section>

  <!-- BENCHMARK -->
  <section id="benchmark" class="page">
    <h1>Benchmark Concurrence</h1>
    <div class="grid-2">
      <div class="card">
        <h3>Nouveautés</h3>
        <table id="benchTable" class="table"></table>
      </div>
      <div class="card">
        <h3>Prix moyens concurrents vs Papothé (démo)</h3>
        <canvas id="benchBar" class="responsive"></canvas>
      </div>
    </div>
  </section>

  <!-- EXPORTS -->
  <section id="exports" class="page">
    <h1>Exports</h1>
    <div class="card">
      <button id="exportAll" class="btn">⬇️ Télécharger les données (JSON)</button>
    </div>
  </section>

</div>

<script>
/* ---------- State & Utils ---------- */
const DPR = window.devicePixelRatio || 1;
const fmtEUR = n => n.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
const byId = id => document.getElementById(id);

/* ---------- Demo Data (same as avant) ---------- */
const DATA = (()=>{ 
  const daily=[], start=new Date('2025-01-01'), end=new Date('2025-08-27');
  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const weekend = ([0,6].includes(d.getDay())?1.25:0.8);
    const trend = 1 + ( (d-start)/(1000*60*60*24) )*0.0009;
    const noise = 1 + (Math.random()*0.4-0.18);
    const ttc = Math.max(0, Math.round(700*weekend*trend*noise));
    const taxRate = Math.random()<0.65?0.055:0.20;
    const taxes = +(ttc*(taxRate/(1+taxRate))).toFixed(2);
    daily.push({date:d.toISOString().slice(0,10), total_ttc:ttc, taxes, orders:Math.max(1, Math.round(ttc/35 + (Math.random()*6-3)))});
  }
  const products=[{name:"Jasmin",sku:"TEA-JASM",category:"thé vert",price_ttc:8.9,cost_ht:2.1},{name:"Prince Ali",sku:"TEA-ALIP",category:"thé noir",price_ttc:9.9,cost_ht:2.3},{name:"Soleil d'Orient",sku:"TEA-SOLI",category:"infusion",price_ttc:8.5,cost_ht:2.0},{name:"Baiser Fruité",sku:"TEA-BAIS",category:"infusion",price_ttc:8.9,cost_ht:2.2},{name:"Éclat et Vitalité",sku:"TEA-EVIT",category:"infusion",price_ttc:7.9,cost_ht:2.0},{name:"Tisanière Verre",sku:"ACC-TISA",category:"accessoire",price_ttc:24.9,cost_ht:6.5},{name:"Fouet Matcha",sku:"ACC-FUET",category:"accessoire",price_ttc:15.9,cost_ht:3.5},{name:"Matcha Cérémonial Hisui 30g",sku:"MAC-HISU-30",category:"matcha",price_ttc:19.0,cost_ht:13.0}];
  const prod_sales = products.map(p=>{
    const qty = Math.floor(60+Math.random()*390);
    const tva = p.category!=="accessoire"?0.055:0.20;
    const ca = +(qty*p.price_ttc).toFixed(2);
    const ht = +(ca/(1+tva)).toFixed(2);
    const cost = +(qty*p.cost_ht).toFixed(2);
    const marge = +(ht - cost).toFixed(2);
    return {sku:p.sku, produit:p.name, category:p.category, ventes:qty, ca_ttc:ca, ca_ht:ht, cout_ht:cost, marge_ht:marge};
  });
  const competitors=[{date:"2025-08-20", competitor:"Kusmi Tea", type:"Nouveau produit", title:"Infusion Détox Citron-Gingembre", price:13.9, category:"infusion", diff:"Bio + pack premium", source:"#"},
                     {date:"2025-08-18", competitor:"Palais des Thés", type:"Promo", title:"-20% sur thés verts", price:null, category:"thé vert", diff:"Promo saisonnière", source:"#"},
                     {date:"2025-08-12", competitor:"Panda Tea", type:"Collab", title:"Coffret Matcha x Créateur", price:24.9, category:"matcha", diff:"Collaboration influenceur", source:"#"}];
  return {daily, products:prod_sales, competitors};
})();

/* ---------- Navigation ---------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('visible'));
    document.getElementById(btn.dataset.target).classList.add('visible');
    redrawAllCanvases(); // au changement d’onglet, on recalcule les tailles
  });
});

/* ---------- Période : année civile 01/01 → 31/12 ---------- */
let CURRENT={from:null,to:null};
function setQuickRange(val){
  const today=new Date();
  let from, to;
  if(val==='last7'){ to=today; from=new Date(today.getFullYear(), today.getMonth(), today.getDate()-6); }
  else if(val==='mtd'){ to=today; from=new Date(today.getFullYear(), today.getMonth(), 1); }
  else if(val==='qtd'){ to=today; const qStart=Math.floor(today.getMonth()/3)*3; from=new Date(today.getFullYear(), qStart, 1); }
  else if(val==='ytd'){ // année civile (01/01 → 31/12)
    from = new Date(today.getFullYear(), 0, 1);
    to   = new Date(today.getFullYear(), 11, 31);
  }
  else if(val==='all'){ from=new Date('2025-01-01'); to=today; }
  else { from=new Date('2025-01-01'); to=today; }
  byId('from').value = from.toISOString().slice(0,10);
  byId('to').value   = to.toISOString().slice(0,10);
}
byId('quickRange').addEventListener('change', e=> setQuickRange(e.target.value));
byId('applyRange').addEventListener('click', ()=>{ CURRENT.from=new Date(byId('from').value); CURRENT.to=new Date(byId('to').value); renderAll(); });

/* ---------- Helpers table ---------- */
function renderTable(table, headers, rows){
  table.innerHTML=''; const thead=document.createElement('thead'); const trh=document.createElement('tr');
  headers.forEach(h=>{const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);}); thead.appendChild(trh);
  const tbody=document.createElement('tbody');
  rows.forEach(r=>{const tr=document.createElement('tr'); headers.forEach(h=>{const td=document.createElement('td'); td.textContent=r[h]; tr.appendChild(td);}); tbody.appendChild(tr);});
  table.appendChild(thead); table.appendChild(tbody);
}

/* ---------- Canvas sizing (responsive + HiDPI) ---------- */
function fitCanvas(c){
  const box = c.getBoundingClientRect();
  c.width  = Math.max(300, Math.floor(box.width*DPR));
  c.height = Math.floor((box.width*0.45)*DPR); // ratio 45% pour bien remplir
  const ctx = c.getContext('2d'); ctx.scale(DPR, DPR);
}
function redrawAllCanvases(){ document.querySelectorAll('canvas.responsive').forEach(fitCanvas); }

/* ---------- Charts avec graduations/labels ---------- */
function drawLineChart(canvas, labels, values, opts={}){
  fitCanvas(canvas);
  const ctx = canvas.getContext('2d'), W = canvas.width/DPR, H = canvas.height/DPR;
  const padL=48, padR=16, padT=16, padB=28;
  const min = Math.min(...values), max = Math.max(...values)*1.1;
  // grille + axes + ticks Y
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#e9edf3'; ctx.lineWidth=1;
  const ticks = 5;
  for(let i=0;i<=ticks;i++){
    const y = padT + (H-padT-padB)*(i/ticks);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    const val = Math.round(max - (max-min)*(i/ticks));
    ctx.fillStyle='#6b778a'; ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.font='12px system-ui';
    ctx.fillText(val.toLocaleString('fr-FR'), padL-6, y);
  }
  // abscisses (quelques labels)
  const xCount = Math.min(8, labels.length);
  for(let i=0;i<=xCount;i++){
    const xi = Math.round((labels.length-1)*(i/xCount));
    const x = padL + (W-padL-padR)*(xi/(labels.length-1));
    ctx.fillStyle='#6b778a'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.font='12px system-ui';
    ctx.fillText(labels[xi], x, H-padB+6);
  }
  // courbe
  ctx.strokeStyle = opts.color || '#1f5fbf'; ctx.lineWidth=2; ctx.beginPath();
  values.forEach((v,i)=>{
    const x = padL + (W-padL-padR)*(i/(values.length-1));
    const y = padT + (H-padT-padB) * (1 - (v-min)/(max-min));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}
function drawBarChart(canvas, labels, values, opts={}){
  fitCanvas(canvas);
  const ctx = canvas.getContext('2d'), W = canvas.width/DPR, H = canvas.height/DPR;
  const padL=48, padR=16, padT=16, padB=28;
  const max = Math.max(...values)*1.15; const n=values.length;
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle='#e9edf3'; for(let i=0;i<=5;i++){ let y=padT+(H-padT-padB)*i/5; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    const val = Math.round(max*(1 - i/5));
    ctx.fillStyle='#6b778a'; ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.font='12px system-ui';
    ctx.fillText(val.toLocaleString('fr-FR'), padL-6, y);
  }
  const bw=(W-padL-padR)/n*0.68, gap=(W-padL-padR)/n*0.32; ctx.fillStyle=opts.color||'#1f5fbf';
  values.forEach((v,i)=>{
    const x = padL + i*(bw+gap);
    const h = (v/max)*(H-padT-padB);
    ctx.fillRect(x, H-padB-h, bw, h);
    // labels X clairsemés
    ctx.fillStyle='#6b778a'; ctx.textAlign='center'; ctx.textBaseline='top'; ctx.font='12px system-ui';
    ctx.fillText(labels[i], x+bw/2, H-padB+6);
    ctx.fillStyle=opts.color||'#1f5fbf';
  });
}
function drawPie(canvas, values, colors){
  fitCanvas(canvas);
  const ctx = canvas.getContext('2d'), W = canvas.width/DPR, H = canvas.height/DPR, r=Math.min(W,H)/2-10;
  ctx.clearRect(0,0,W,H);
  let total = values.reduce((a,b)=>a+b,0), ang=-Math.PI/2;
  values.forEach((v,i)=>{
    const a = (v/total)*Math.PI*2;
    ctx.beginPath(); ctx.moveTo(W/2,H/2); ctx.arc(W/2,H/2,r,ang,ang+a); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]; ctx.fill(); ang += a;
  });
}

/* ---------- KPI & Calculs ---------- */
function withinPeriod(d){ const when=new Date(d); return (!CURRENT.from||when>=CURRENT.from)&&(!CURRENT.to||when<=CURRENT.to); }
function computeKPIs(){
  const days=DATA.daily.filter(x=>withinPeriod(x.date));
  const cattt=days.reduce((s,x)=>s+x.total_ttc,0), taxes=days.reduce((s,x)=>s+x.taxes,0), caht=cattt-taxes;
  const orders=days.reduce((s,x)=>s+x.orders,0);
  const fixed=3800, months=Math.max(1, ((CURRENT.to-CURRENT.from)/(1000*60*60*24*30)));
  const fixedProrata=fixed*months, variable=cattt*0.18, cogs=caht*0.42, marge=caht-cogs, result=caht-cogs-fixedProrata-variable;
  return {days,cattt,caht,taxes,orders,marge,result,fixedProrata,variable,cogs};
}

/* ---------- Renderers ---------- */
function renderDashboard(k){
  byId('kpi-cattt').textContent=fmtEUR(k.cattt);
  byId('kpi-caht').textContent=fmtEUR(k.caht);
  byId('kpi-marge').textContent=fmtEUR(k.marge);
  byId('kpi-tva').textContent=fmtEUR(k.taxes);
  const box=byId('kpi-result-box'), v=byId('kpi-result');
  if(k.result>=0){ box.classList.add('success'); box.classList.remove('danger'); v.textContent='+'+fmtEUR(k.result); }
  else{ box.classList.add('danger'); box.classList.remove('success'); v.textContent='−'+fmtEUR(Math.abs(k.result)); }
  const labels=k.days.map(x=>x.date.slice(5)), values=k.days.map(x=>x.total_ttc);
  drawLineChart(byId('dashLine'), labels, values, {color:'#1f5fbf'});
  const avg=values.reduce((a,b)=>a+b,0)/Math.max(1,values.length);
  const proj=Array.from({length:30},(_,i)=>avg*(1+i*0.02));
  drawLineChart(byId('dashProj'), Array.from({length:30},(_,i)=>i+1), proj, {color:'#0f8a5f'});
  const expVals=[k.cogs,k.fixedProrata,k.variable]; const expColors=['#1f5fbf','#d06a4e','#9ec5ff']; const expNames=['COGS','Fixes','Variables'];
  drawPie(byId('dashPie'), expVals, expColors);
  // Légende dépenses avec %
  const totalExp = expVals.reduce((a,b)=>a+b,0);
  byId('legend-expenses').innerHTML = expVals.map((v,i)=>{
    const pct = totalExp? Math.round(v*100/totalExp):0;
    return `<span class="item"><span class="dot" style="background:${expColors[i]}"></span>${expNames[i]} — ${pct}%</span>`;
  }).join('');
  // Répartition CA par canal + légende %
  const chNames=['Site','Revendeurs','Salons','B2B'];
  const chVals=[k.cattt*0.5,k.cattt*0.22,k.cattt*0.16,k.cattt*0.12];
  drawBarChart(byId('dashBar'), chNames, chVals, {color:'#d06a4e'});
  const totalCh = chVals.reduce((a,b)=>a+b,0);
  byId('legend-channels').innerHTML = chVals.map((v,i)=>{
    const pct = totalCh? Math.round(v*100/totalCh):0;
    return `<span class="item"><span class="dot" style="background:#d06a4e"></span>${chNames[i]} — ${pct}%</span>`;
  }).join('');
}
function renderSales(k){
  byId('sales-cattt').textContent=fmtEUR(k.cattt);
  byId('sales-orders').textContent=k.orders.toLocaleString('fr-FR');
  const aov=k.orders>0?k.cattt/k.orders:0; byId('sales-aov').textContent=fmtEUR(aov);
  byId('sales-repeat').textContent=(18+(aov>40?5:0)).toFixed(1)+' %';
  drawLineChart(byId('salesLine'), k.days.map(d=>d.date.slice(5)), k.days.map(d=>d.total_ttc), {color:'#1f5fbf'});
  const monthly={}; k.days.forEach(d=>{const m=d.date.slice(0,7); monthly[m]=(monthly[m]||0)+d.total_ttc;});
  drawBarChart(byId('salesBar'), Object.keys(monthly), Object.values(monthly), {color:'#d06a4e'});
  const rows=k.days.slice(-20).reverse().map(d=>({Date:d.date, Client:'Client '+Math.ceil(Math.random()*2000), Montant:fmtEUR(d.total_ttc), Statut:(Math.random()>0.15?'Soldée':'En cours'), Canal:(['Site','Salon','B2B','Revendeur'][Math.floor(Math.random()*4)])}));
  renderTable(byId('salesTable'), ['Date','Client','Montant','Statut','Canal'], rows);
  byId('exportCsv').onclick=()=>{const header='date,total_ttc,taxes,orders\n'; const content=k.days.map(d=>`${d.date},${d.total_ttc},${d.taxes},${d.orders}`).join('\n'); const blob=new Blob([header+content],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='journal_ventes.csv'; a.click();};
}
function renderProducts(){
  const items=DATA.products.slice();
  items.forEach(it=>{it.marge_pct=it.ca_ht>0?(it.marge_ht/it.ca_ht)*100:0; it.suggestion=(it.marge_ht<0||it.marge_pct<5||it.ca_ht<500)?'À arrêter':(it.marge_pct>55&&it.ca_ht<3000)?'Booster en pack':(it.marge_pct>45&&it.ca_ht>=3000)?'Mettre en avant':'—';});
  const qty=items.reduce((s,x)=>s+x.ventes,0), ca=items.reduce((s,x)=>s+x.ca_ttc,0), margin=items.reduce((s,x)=>s+x.marge_ht,0), roi=(margin/(items.reduce((s,x)=>s+x.ca_ht,0)||1))*100;
  byId('prod-qty').textContent=qty.toLocaleString('fr-FR'); byId('prod-ca').textContent=fmtEUR(ca); byId('prod-margin').textContent=fmtEUR(margin); byId('prod-roi').textContent=roi.toFixed(1)+' %';
  const headers=['Produit','Ventes','CA TTC','Coût HT','Marge HT','Rentabilité','Suggestion'];
  const rows=items.map(x=>({'Produit':x.produit,'Ventes':x.ventes.toLocaleString('fr-FR'),'CA TTC':fmtEUR(x.ca_ttc),'Coût HT':fmtEUR(x.cout_ht),'Marge HT':fmtEUR(x.marge_ht),'Rentabilité':x.marge_pct.toFixed(1)+' %','Suggestion':x.suggestion}));
  renderTable(byId('prodTable'), headers, rows);
  const top=items.slice().sort((a,b)=>b.ca_ttc-a.ca_ttc).slice(0,5), flop=items.slice().sort((a,b)=>a.marge_ht-b.marge_ht).slice(0,5);
  byId('topList').innerHTML=top.map(x=>`<li>${x.produit} — ${fmtEUR(x.ca_ttc)}</li>`).join(''); byId('flopList').innerHTML=flop.map(x=>`<li>${x.produit} — marge ${fmtEUR(x.marge_ht)}</li>`).join('');
  drawBarChart(byId('prodBar'), items.map(x=>x.produit.slice(0,10)), items.map(x=>x.ca_ttc), {color:'#1f5fbf'});
  drawBarChart(byId('prodBar2'), items.map(x=>x.produit.slice(0,10)), items.map(x=>x.marge_pct), {color:'#0f8a5f'});
}
function renderBenchmark(){
  const headers=['Date','Concurrent','Type','Produit','Prix','Catégorie','Différenciateur','Source'];
  const rows=DATA.competitors.map(c=>({'Date':c.date,'Concurrent':c.competitor,'Type':c.type,'Produit':c.title,'Prix':c.price?fmtEUR(c.price):'—','Catégorie':c.category,'Différenciateur':c.diff,'Source':c.source}));
  renderTable(byId('benchTable'), headers, rows);
  drawBarChart(byId('benchBar'), ['Papothé','Kusmi','PDT','Panda'], [12.5,13.9,14.5,12.9], {color:'#d06a4e'});
}

/* ---------- Init + Resize ---------- */
function renderAll(){ const k=computeKPIs(); renderDashboard(k); renderSales(k); renderProducts(); renderBenchmark(); }
function init(){
  // Année civile par défaut (01/01 -> 31/12)
  const today=new Date(); byId('from').value=(new Date(today.getFullYear(),0,1)).toISOString().slice(0,10);
  byId('to').value=(new Date(today.getFullYear(),11,31)).toISOString().slice(0,10);
  CURRENT.from=new Date(byId('from').value); CURRENT.to=new Date(byId('to').value);
  renderAll();
  window.addEventListener('resize', ()=>{ redrawAllCanvases(); renderAll(); });
}
init();

/* ---------- Projects & Exports ---------- */
byId('pRun').addEventListener('click', ()=>{
  const inv=+byId('pInvest').value||0, traffic=+byId('pTraffic').value||0, conv=(+byId('pConv').value||0)/100, aov=+byId('pAOV').value||0, varRate=(+byId('pVar').value||0)/100;
  const sales=traffic*conv, cattt=sales*aov, caht=cattt/1.055, cogs=caht*0.4, variable=cattt*varRate, result=caht-cogs-variable-inv, roi=inv? (result/inv)*100:0;
  byId('pResults').innerHTML=`<li>CA TTC prévisionnel: <b>${fmtEUR(cattt)}</b></li>
  <li>Résultat estimé: <b style="color:${result>=0?'#0f8a5f':'#c13515'}">${result>=0?'+':''}${fmtEUR(result)}</b></li>
  <li>ROI: <b>${roi.toFixed(1)}%</b></li>`;
  const pess=result*0.6, real=result, opt=result*1.4;
  drawBarChart(byId('projChart'), ['Pessimiste','Réaliste','Optimiste'], [pess,real,opt], {color:'#1f5fbf'});
});
byId('exportAll').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='papothe_data.json'; a.click(); });
</script>
</body>
</html>
